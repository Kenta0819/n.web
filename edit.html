<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ローカル掲示板 管理画面</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', 'Roboto', 'Meiryo', 'Segoe UI', sans-serif;
      background: radial-gradient(ellipse at 60% 20%, #232526 60%, #1a1a1a 100%);
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      letter-spacing: 0.03em;
    }
    .main-flex {
      display: flex;
      align-items: flex-start;
      max-width: 800px;
      margin: 48px auto 0 auto;
      box-shadow: 0 8px 40px #000a, 0 1.5px 0 #3a4e6a;
      border-radius: 22px;
      background: rgba(30,34,44,0.98);
    }
    .view-counter-bar {
      min-width: 90px;
      max-width: 110px;
      background: linear-gradient(120deg, #232526 0%, #3a4e6a 100%);
      border-radius: 22px 0 0 22px;
      box-shadow: 0 8px 32px #000a, 0 1.5px 0 #3a4e6a;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 38px 0 38px 0;
      margin-right: 0;
      height: 100%;
      position: sticky;
      top: 0;
      z-index: 2;
      border-right: 2px solid #263040;
    }
    .view-counter-label {
      font-size: 1.08em;
      color: #ffe082;
      margin-bottom: 10px;
      letter-spacing: 0.08em;
      text-shadow: 0 2px 8px #000a;
    }
    .view-counter-num {
      font-size: 2.5em;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 2px 12px #000a;
      margin-bottom: 8px;
      letter-spacing: 0.08em;
    }
    .reset-btn, .reflect-btn {
      background: #ff8a65;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 18px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      margin: 8px 0 0 0;
      transition: background 0.2s;
    }
    .reset-btn:hover, .reflect-btn:hover {
      background: #ffb199;
    }
    .container {
      flex: 1 1 0;
      background: rgba(30,34,44,0.98);
      border-radius: 0 22px 22px 0;
      box-shadow: none;
      padding: 38px 32px 38px 32px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h1 {
      text-align: center;
      color: #6ec6ff;
      margin-bottom: 10px;
      font-size: 2.2em;
      letter-spacing: 0.12em;
      text-shadow: 0 2px 16px #000a;
      font-family: 'Montserrat', 'Roboto', sans-serif;
      font-weight: 700;
    }
    .section-title {
      font-size: 1.1em;
      font-weight: bold;
      margin: 24px 0 10px 0;
      color: #ffe082;
      letter-spacing: 0.08em;
      border-bottom: 1px solid #3a4e6a;
      padding-bottom: 4px;
    }
    label {
      display: block;
      margin: 10px 0 4px 0;
      color: #b3e5fc;
    }
    input[type="text"], textarea {
      width: 100%;
      font-size: 1em;
      padding: 8px;
      border-radius: 6px;
      border: 1.5px solid #6ec6ff;
      background: #222;
      color: #fff;
      resize: vertical;
      margin-bottom: 8px;
    }
    input[type="file"] {
      color: #fff;
      margin-bottom: 8px;
    }
    button[type="submit"] {
      padding: 8px 24px;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      background: #1976d2;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
      margin-bottom: 12px;
    }
    button[type="submit"]:hover {
      background: #29b6f6;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .news-item {
      background: #444;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      word-break: break-all;
      box-shadow: 0 1px 4px #0005;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .news-date { font-size: 0.85em; color: #ff8a65; text-align: right; }
    .news-text { font-size: 1em; color: #fff; }
    .news-photo {
      max-width: 100%;
      max-height: 120px;
      border-radius: 6px;
      margin-bottom: 6px;
      border: 1px solid #888;
      background: #222;
      object-fit: contain;
    }
    .delete-btn {
      background: #ff1744;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 12px;
      font-size: 0.95em;
      margin-top: 6px;
      cursor: pointer;
      align-self: flex-end;
    }
    .delete-btn:hover {
      background: #ff5252;
    }
    .music-info {
      margin-bottom: 12px;
      color: #b3e5fc;
    }
    @media (max-width: 900px) {
      .main-flex {
        flex-direction: column;
        max-width: 100vw;
        border-radius: 0;
      }
      .view-counter-bar {
        flex-direction: row;
        min-width: 100%;
        max-width: 100%;
        border-radius: 22px 22px 0 0;
        padding: 16px 0 8px 0;
        margin-bottom: 0;
        margin-right: 0;
        justify-content: center;
        position: static;
        border-right: none;
        border-bottom: 2px solid #263040;
      }
      .container {
        border-radius: 0 0 22px 22px;
        box-shadow: none;
        padding: 18px 4vw 24px 4vw;
      }
    }
  </style>
</head>
<body>
  <div class="main-flex">
    <div class="view-counter-bar">
      <div class="view-counter-label">閲覧回数</div>
      <div class="view-counter-num" id="viewCountAdmin">0</div>
      <button class="reset-btn" onclick="resetViewCount()">リセット</button>
      <button class="reflect-btn" onclick="reflectAll()">反映</button>
    </div>
    <div class="container">
      <h1>管理画面</h1>

      <div class="section-title">重要なお知らせの編集</div>
      <form id="emergencyForm">
        <textarea id="emergencyText" rows="2" placeholder="重要なお知らせを入力"></textarea>
        <button type="submit">保存</button>
        <button type="button" class="reflect-btn" onclick="reflectEmergency()">反映</button>
      </form>

      <div class="section-title">お知らせの追加（画像可）</div>
      <form id="newsForm">
        <input type="text" id="newsText" placeholder="お知らせ内容">
        <input type="file" id="newsPhoto" accept="image/*">
        <button type="submit">追加</button>
        <button type="button" class="reflect-btn" onclick="reflectNews()">反映</button>
      </form>
      <ul id="newsListAdmin"></ul>

      <div class="section-title">今日の音楽の設定</div>
      <form id="musicForm">
        <input type="text" id="musicTitle" placeholder="曲名">
        <input type="file" id="musicFile" accept="audio/*">
        <button type="submit">保存</button>
        <button type="button" class="reflect-btn" onclick="reflectMusic()">反映</button>
      </form>
      <div class="music-info" id="musicInfo"></div>
    </div>
  </div>
  <script>
    // 閲覧回数
    function updateViewCountAdmin() {
      document.getElementById('viewCountAdmin').textContent = localStorage.getItem('bbsViewCount') || '0';
    }
    function resetViewCount() {
      localStorage.setItem('bbsViewCount', '0');
      updateViewCountAdmin();
      window.dispatchEvent(new StorageEvent('storage', {key: 'bbsViewCount'}));
    }
    updateViewCountAdmin();

    // 反映ボタン（全体）
    function reflectAll() {
      window.dispatchEvent(new StorageEvent('storage', {key: 'newsPosts'}));
      window.dispatchEvent(new StorageEvent('storage', {key: 'emergencyText'}));
      window.dispatchEvent(new StorageEvent('storage', {key: 'musicData'}));
      window.dispatchEvent(new StorageEvent('storage', {key: 'bbsViewCount'}));
      alert('全体に反映しました');
    }
    function reflectEmergency() {
      window.dispatchEvent(new StorageEvent('storage', {key: 'emergencyText'}));
      alert('反映しました');
    }
    function reflectNews() {
      window.dispatchEvent(new StorageEvent('storage', {key: 'newsPosts'}));
      alert('反映しました');
    }
    function reflectMusic() {
      window.dispatchEvent(new StorageEvent('storage', {key: 'musicData'}));
      alert('反映しました');
    }

    // 重要お知らせ
    function loadEmergency() {
      return localStorage.getItem('emergencyText') || "";
    }
    function saveEmergency(text) {
      localStorage.setItem('emergencyText', text);
      window.dispatchEvent(new StorageEvent('storage', {key: 'emergencyText'}));
    }
    document.getElementById('emergencyText').value = loadEmergency();
    document.getElementById('emergencyForm').onsubmit = function(e) {
      e.preventDefault();
      saveEmergency(document.getElementById('emergencyText').value.trim());
      alert('保存しました');
    };

    // お知らせ
    function loadNews() {
      const data = localStorage.getItem('newsPosts');
      return data ? JSON.parse(data) : [];
    }
    function saveNews(news) {
      localStorage.setItem('newsPosts', JSON.stringify(news));
      window.dispatchEvent(new StorageEvent('storage', {key: 'newsPosts'}));
    }
    function renderNewsAdmin() {
      const news = loadNews();
      const ul = document.getElementById('newsListAdmin');
      ul.innerHTML = '';
      news.slice().reverse().forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'news-item';
        if (item.photo) {
          const img = document.createElement('img');
          img.src = item.photo;
          img.className = 'news-photo';
          li.appendChild(img);
        }
        li.innerHTML += `<div class="news-text">${item.text}</div>
          <div class="news-date">${item.date}</div>`;
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = '削除';
        delBtn.onclick = function() {
          if (confirm('このお知らせを削除しますか？')) {
            news.splice(news.length - 1 - idx, 1);
            saveNews(news);
            renderNewsAdmin();
          }
        };
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
    }
    renderNewsAdmin();
    document.getElementById('newsForm').onsubmit = function(e) {
      e.preventDefault();
      const text = document.getElementById('newsText').value.trim();
      const file = document.getElementById('newsPhoto').files[0];
      if (!text) return;
      const news = loadNews();
      const date = new Date().toLocaleString('ja-JP', { hour12: false });
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          news.push({text, date, photo: ev.target.result});
          saveNews(news);
          renderNewsAdmin();
        };
        reader.readAsDataURL(file);
      } else {
        news.push({text, date, photo: null});
        saveNews(news);
        renderNewsAdmin();
      }
      document.getElementById('newsText').value = '';
      document.getElementById('newsPhoto').value = '';
    };

    // 音楽
    function loadMusic() {
      const data = localStorage.getItem('musicData');
      return data ? JSON.parse(data) : null;
    }
    function saveMusic(music) {
      localStorage.setItem('musicData', JSON.stringify(music));
      window.dispatchEvent(new StorageEvent('storage', {key: 'musicData'}));
    }
    function renderMusicInfo() {
      const music = loadMusic();
      const info = document.getElementById('musicInfo');
      if (music && music.title) {
        info.innerHTML = `<b>現在の曲:</b> ${music.title}<br>${music.audio ? '<audio controls src="'+music.audio+'" style="width:100%;margin-top:8px;"></audio>' : ''}`;
      } else {
        info.textContent = '未設定';
      }
    }
    renderMusicInfo();
    document.getElementById('musicForm').onsubmit = function(e) {
      e.preventDefault();
      const title = document.getElementById('musicTitle').value.trim();
      const file = document.getElementById('musicFile').files[0];
      if (!title) { alert('曲名を入力してください'); return; }
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          saveMusic({title, audio: ev.target.result});
          renderMusicInfo();
          alert('保存しました');
        };
        reader.readAsDataURL(file);
      } else {
        saveMusic({title, audio: null});
        renderMusicInfo();
        alert('保存しました');
      }
      document.getElementById('musicTitle').value = '';
      document.getElementById('musicFile').value = '';
    };

    // ストレージ変更時に自動反映
    window.addEventListener('storage', function(e) {
      if (e.key === 'newsPosts') renderNewsAdmin();
      if (e.key === 'musicData') renderMusicInfo();
      if (e.key === 'emergencyText') document.getElementById('emergencyText').value = loadEmergency();
      if (e.key === 'bbsViewCount') updateViewCountAdmin();
    });
  </script>
</body>
</html>